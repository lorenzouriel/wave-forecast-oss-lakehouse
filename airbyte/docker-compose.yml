services:
  airbyte-db:
    image: postgres:15
    container_name: airbyte-db
    env_file:
      - .env
    environment:
      POSTGRES_USER: ${AIRBYTE_DB_USER}
      POSTGRES_PASSWORD: ${AIRBYTE_DB_PASSWORD}
      POSTGRES_DB: ${AIRBYTE_DB}
    volumes:
      - airbyte-db-volume:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${AIRBYTE_DB_USER}"]
      interval: 10s
      retries: 5
      start_period: 5s
    restart: unless-stopped
    networks:
      - lakehouse-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  airbyte-init:
    image: airbyte/init:1.0.0
    container_name: airbyte-init
    env_file:
      - .env
    command: /bin/sh -c "./scripts/create_mount_directories.sh /local_parent ${HACK_LOCAL_ROOT_PARENT} ${LOCAL_ROOT}"
    environment:
      LOCAL_ROOT: ${LOCAL_ROOT}
      HACK_LOCAL_ROOT_PARENT: ${HACK_LOCAL_ROOT_PARENT}
    volumes:
      - airbyte-volume:/local_parent
    networks:
      - lakehouse-network

  airbyte-bootloader:
    image: airbyte/bootloader:1.0.0
    container_name: airbyte-bootloader
    env_file:
      - .env
    environment:
      DATABASE_USER: ${AIRBYTE_DB_USER}
      DATABASE_PASSWORD: ${AIRBYTE_DB_PASSWORD}
      DATABASE_URL: jdbc:postgresql://airbyte-db:5432/${AIRBYTE_DB}
      LOCAL_ROOT: ${LOCAL_ROOT}
    depends_on:
      airbyte-db:
        condition: service_healthy
    networks:
      - lakehouse-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  airbyte-server:
    image: airbyte/server:1.0.0
    container_name: airbyte-server
    ports:
      - "8001:8001"
    env_file:
      - .env
    environment:
      DATABASE_USER: ${AIRBYTE_DB_USER}
      DATABASE_PASSWORD: ${AIRBYTE_DB_PASSWORD}
      DATABASE_URL: jdbc:postgresql://airbyte-db:5432/${AIRBYTE_DB}
      CONFIG_ROOT: ${CONFIG_ROOT}
      LOCAL_ROOT: ${LOCAL_ROOT}
      WORKSPACE_ROOT: ${WORKSPACE_ROOT}
      TEMPORAL_HOST: airbyte-temporal:7233
      TRACKING_STRATEGY: segment
      AIRBYTE_VERSION: 1.0.0
      AIRBYTE_ROLE: ${AIRBYTE_ROLE}
      LOG_LEVEL: ${LOG_LEVEL}
    volumes:
      - airbyte-volume:${LOCAL_ROOT}
      - airbyte-workspace:${WORKSPACE_ROOT}
    depends_on:
      airbyte-db:
        condition: service_healthy
      airbyte-bootloader:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      - lakehouse-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  airbyte-temporal:
    image: airbyte/temporal:1.0.0
    container_name: airbyte-temporal
    ports:
      - "7233:7233"
    env_file:
      - .env
    environment:
      DB: postgresql
      DB_PORT: 5432
      POSTGRES_USER: ${AIRBYTE_DB_USER}
      POSTGRES_PWD: ${AIRBYTE_DB_PASSWORD}
      POSTGRES_SEEDS: airbyte-db
      DYNAMIC_CONFIG_FILE_PATH: config/dynamicconfig/development.yaml
      LOG_LEVEL: ${LOG_LEVEL}
    volumes:
      - ./temporal-dynamicconfig:/etc/temporal/config/dynamicconfig
    depends_on:
      airbyte-db:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - lakehouse-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  airbyte-worker:
    image: airbyte/worker:1.0.0
    container_name: airbyte-worker
    env_file:
      - .env
    environment:
      DATABASE_USER: ${AIRBYTE_DB_USER}
      DATABASE_PASSWORD: ${AIRBYTE_DB_PASSWORD}
      DATABASE_URL: jdbc:postgresql://airbyte-db:5432/${AIRBYTE_DB}
      CONFIG_ROOT: ${CONFIG_ROOT}
      LOCAL_ROOT: ${LOCAL_ROOT}
      WORKSPACE_ROOT: ${WORKSPACE_ROOT}
      TEMPORAL_HOST: airbyte-temporal:7233
      TRACKING_STRATEGY: segment
      AIRBYTE_VERSION: 1.0.0
      AIRBYTE_ROLE: ${AIRBYTE_ROLE}
      LOG_LEVEL: ${LOG_LEVEL}
      LOCAL_DOCKER_MOUNT: ${LOCAL_DOCKER_MOUNT}
      WORKSPACE_DOCKER_MOUNT: ${WORKSPACE_DOCKER_MOUNT}
    volumes:
      - airbyte-volume:${LOCAL_ROOT}
      - airbyte-workspace:${WORKSPACE_ROOT}
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      airbyte-db:
        condition: service_healthy
      airbyte-bootloader:
        condition: service_completed_successfully
      airbyte-temporal:
        condition: service_started
    restart: unless-stopped
    networks:
      - lakehouse-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  airbyte-webapp:
    image: airbyte/webapp:1.0.0
    container_name: airbyte-webapp
    ports:
      - "8000:8080"
    env_file:
      - .env
    environment:
      AIRBYTE_ROLE: ${AIRBYTE_ROLE}
      AIRBYTE_VERSION: 1.0.0
      API_URL: http://airbyte-server:8001/api/v1/
      INTERNAL_API_HOST: airbyte-server:8001
      CONNECTOR_BUILDER_API_HOST: airbyte-connector-builder-server:80
      TRACKING_STRATEGY: segment
    depends_on:
      - airbyte-server
    restart: unless-stopped
    networks:
      - lakehouse-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  airbyte-connector-builder-server:
    image: airbyte/connector-builder-server:1.0.0
    container_name: airbyte-connector-builder-server
    ports:
      - "8003:80"
    env_file:
      - .env
    environment:
      AIRBYTE_VERSION: 1.0.0
      CDK_VERSION: ${CDK_VERSION}
    restart: unless-stopped
    networks:
      - lakehouse-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  airbyte-cron:
    image: airbyte/cron:1.0.0
    container_name: airbyte-cron
    env_file:
      - .env
    environment:
      DATABASE_USER: ${AIRBYTE_DB_USER}
      DATABASE_PASSWORD: ${AIRBYTE_DB_PASSWORD}
      DATABASE_URL: jdbc:postgresql://airbyte-db:5432/${AIRBYTE_DB}
      WORKSPACE_ROOT: ${WORKSPACE_ROOT}
      TEMPORAL_HISTORY_RETENTION_IN_DAYS: ${TEMPORAL_HISTORY_RETENTION_IN_DAYS}
      LOG_LEVEL: ${LOG_LEVEL}
    volumes:
      - airbyte-workspace:${WORKSPACE_ROOT}
    depends_on:
      airbyte-db:
        condition: service_healthy
      airbyte-bootloader:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      - lakehouse-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  airbyte-db-volume:
    driver: local
  airbyte-volume:
    driver: local
  airbyte-workspace:
    driver: local

networks:
  lakehouse-network:
    external: true
